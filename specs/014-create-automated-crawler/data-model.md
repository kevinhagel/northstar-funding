# Data Model - Feature 014: Automated Search Adapter Infrastructure

**Feature**: 014-create-automated-crawler
**Date**: 2025-11-17
**Status**: Complete

## Core Domain Models

### 1. SearchAdapter Interface

**Purpose**: Unified interface for all search engine implementations

**Module**: `northstar-search-adapters`

**Definition**:
```java
package com.northstar.funding.searchadapters;

import com.northstar.funding.domain.SearchEngineType;
import com.northstar.funding.domain.SearchResult;
import java.util.List;

/**
 * Common interface for all search engine adapters.
 * Implementations: BraveSearchAdapter, SerperAdapter, SearXNGAdapter, TavilyAdapter
 */
public interface SearchAdapter {

    /**
     * Execute search query and return results.
     *
     * @param query The search query string (keyword or natural language)
     * @param maxResults Maximum number of results to return
     * @return List of search results (empty list if zero results - NOT an error)
     * @throws SearchAdapterException if API call fails (network, auth, rate limit)
     */
    List<SearchResult> search(String query, int maxResults);

    /**
     * @return The search engine type this adapter implements
     */
    SearchEngineType getEngineType();

    /**
     * Check if this adapter is available (API key configured, service reachable).
     *
     * @return true if adapter can be used, false otherwise
     */
    boolean isAvailable();
}
```

**Implementations Required**:
- `BraveSearchAdapter` - Brave Search API
- `SerperAdapter` - Serper.dev API
- `SearXNGAdapter` - Self-hosted SearXNG @ http://192.168.1.10:8080
- `TavilyAdapter` - Tavily AI Search API

### 2. SearchResult (Existing Entity)

**Purpose**: Represents a single search result from any search engine

**Module**: `northstar-domain`

**Location**: `northstar-domain/src/main/java/com/northstar/funding/domain/SearchResult.java`

**Current Definition** (from migration V17):
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table("search_result")
public class SearchResult {
    @Id
    private UUID searchResultId;

    private String sourceUrl;           // Full URL from search engine
    private String metadataTitle;       // Page title from search metadata
    private String metadataDescription; // Description/snippet from search metadata

    private SearchEngineType searchEngineSource;  // BRAVE, SERPER, SEARXNG, TAVILY
    private LocalDateTime discoveredAt;
    private UUID sessionId;             // FK to discovery_session
}
```

**Usage**: Returned by SearchAdapter.search(), processed by SearchResultProcessor

### 3. SearchWorkflowService (New)

**Purpose**: Orchestrates nightly search workflow

**Module**: `northstar-search-adapters` or `northstar-application`

**Responsibilities**:
- Get today's categories from DayOfWeekCategories enum
- Generate queries via QueryGenerationService
- Execute searches via SearchAdapters (parallel with Virtual Threads)
- Process results via SearchResultProcessor
- Track statistics in DiscoverySession

**Key Methods**:
```java
public class SearchWorkflowService {

    /**
     * Execute complete nightly search workflow.
     *
     * @param dayOfWeek Which day's categories to search (MONDAY-SUNDAY)
     * @return Summary of search execution
     */
    public SearchWorkflowResult executeNightlySearch(DayOfWeek dayOfWeek);

    /**
     * Execute search for specific categories and adapters (manual trigger).
     *
     * @param request Manual search request with categories and engines
     * @return Summary of search execution
     */
    public SearchWorkflowResult executeManualSearch(ManualSearchRequest request);
}
```

### 4. SearchWorkflowResult (New)

**Purpose**: Summary of search workflow execution

**Definition**:
```java
package com.northstar.funding.searchadapters.model;

import com.northstar.funding.domain.SearchEngineType;
import java.time.Duration;
import java.util.Map;
import java.util.UUID;

@Data
@Builder
public class SearchWorkflowResult {
    private UUID sessionId;                    // Discovery session ID
    private int queriesGenerated;              // Total queries generated by Ollama
    private int totalSearchesExecuted;         // Total API calls made
    private int totalResultsFound;             // Sum of all results from all engines
    private int candidatesCreated;             // High confidence (>= 0.6) candidates
    private int duplicatesSkipped;             // Domain-level duplicates
    private int blacklistedSkipped;            // Blacklisted domains
    private int lowConfidenceSkipped;          // Below 0.6 threshold
    private int zeroResultCount;               // Number of query+adapter with zero results
    private Map<SearchEngineType, Integer> resultsByEngine;  // Results per engine
    private Map<SearchEngineType, Integer> zeroResultsByEngine;  // Zero results per engine
    private Duration executionDuration;        // Total execution time
    private boolean hasFailures;               // Any adapter failures?
    private Map<SearchEngineType, String> failureMessages;  // Error messages per engine
}
```

**Usage**: Returned by SearchWorkflowService, logged, stored in DiscoverySession

### 5. ManualSearchRequest (New)

**Purpose**: Request model for manual search execution

**Definition**:
```java
package com.northstar.funding.searchadapters.model;

import com.northstar.funding.domain.FundingSearchCategory;
import com.northstar.funding.domain.SearchEngineType;
import java.util.List;

@Data
@Builder
public class ManualSearchRequest {
    private List<FundingSearchCategory> categories;  // Which categories to search
    private List<SearchEngineType> engines;          // Which adapters to use
    private int maxResultsPerQuery;                   // Default: 10
    private String geographicScope;                   // Default: "Bulgaria, Eastern Europe, EU"
}
```

**Validation**:
- At least 1 category required
- At least 1 engine required
- maxResultsPerQuery: 1-50 range

### 6. DayOfWeekCategories (New Enum)

**Purpose**: Static mapping of FundingSearchCategory to days of week

**Definition**:
```java
package com.northstar.funding.domain;

import java.time.DayOfWeek;
import java.util.List;
import java.util.Map;

public class DayOfWeekCategories {

    private static final Map<DayOfWeek, List<FundingSearchCategory>> SCHEDULE = Map.of(
        DayOfWeek.MONDAY, List.of(
            FundingSearchCategory.INDIVIDUAL_SCHOLARSHIPS,
            FundingSearchCategory.STUDENT_FINANCIAL_AID,
            FundingSearchCategory.TEACHER_SCHOLARSHIPS,
            FundingSearchCategory.ACADEMIC_FELLOWSHIPS
        ),
        DayOfWeek.TUESDAY, List.of(
            FundingSearchCategory.PROGRAM_GRANTS,
            FundingSearchCategory.CURRICULUM_DEVELOPMENT,
            FundingSearchCategory.AFTER_SCHOOL_PROGRAMS,
            FundingSearchCategory.SUMMER_PROGRAMS,
            FundingSearchCategory.EXTRACURRICULAR_ACTIVITIES
        ),
        DayOfWeek.WEDNESDAY, List.of(
            FundingSearchCategory.INFRASTRUCTURE_FUNDING,
            FundingSearchCategory.TECHNOLOGY_EQUIPMENT,
            FundingSearchCategory.LIBRARY_RESOURCES
        ),
        DayOfWeek.THURSDAY, List.of(
            FundingSearchCategory.TEACHER_DEVELOPMENT,
            FundingSearchCategory.PROFESSIONAL_TRAINING,
            FundingSearchCategory.ADMINISTRATIVE_CAPACITY
        ),
        DayOfWeek.FRIDAY, List.of(
            FundingSearchCategory.STEM_EDUCATION,
            FundingSearchCategory.ARTS_EDUCATION,
            FundingSearchCategory.SPECIAL_NEEDS_EDUCATION,
            FundingSearchCategory.LANGUAGE_PROGRAMS
        ),
        DayOfWeek.SATURDAY, List.of(
            FundingSearchCategory.COMMUNITY_PARTNERSHIPS,
            FundingSearchCategory.PARENT_ENGAGEMENT,
            FundingSearchCategory.NGO_EDUCATION_PROJECTS
        ),
        DayOfWeek.SUNDAY, List.of(
            FundingSearchCategory.EDUCATION_RESEARCH,
            FundingSearchCategory.PILOT_PROGRAMS,
            FundingSearchCategory.INNOVATION_GRANTS,
            FundingSearchCategory.EARLY_CHILDHOOD_EDUCATION,
            FundingSearchCategory.ADULT_EDUCATION,
            FundingSearchCategory.VOCATIONAL_TRAINING,
            FundingSearchCategory.EDUCATIONAL_TECHNOLOGY,
            FundingSearchCategory.ARTS_CULTURE
        )
    );

    public static List<FundingSearchCategory> getCategories(DayOfWeek dayOfWeek) {
        return SCHEDULE.get(dayOfWeek);
    }
}
```

### 7. SearchAdapterException (New)

**Purpose**: Custom exception for search adapter failures

**Definition**:
```java
package com.northstar.funding.searchadapters.exception;

import com.northstar.funding.domain.SearchEngineType;

public class SearchAdapterException extends RuntimeException {

    private final SearchEngineType engineType;
    private final String query;

    public SearchAdapterException(SearchEngineType engineType, String query, String message) {
        super(String.format("[%s] Failed query='%s': %s", engineType, query, message));
        this.engineType = engineType;
        this.query = query;
    }

    public SearchAdapterException(SearchEngineType engineType, String query, String message, Throwable cause) {
        super(String.format("[%s] Failed query='%s': %s", engineType, query, message), cause);
        this.engineType = engineType;
        this.query = query;
    }

    public SearchEngineType getEngineType() { return engineType; }
    public String getQuery() { return query; }
}
```

**Usage**: Thrown by SearchAdapter implementations on API failures (NOT for zero results)

### 8. AdapterEffectivenessMetric (Future - Not Implemented in Feature 014)

**Purpose**: Track which adapters work best for which categories

**Definition** (planned):
```java
@Data
@Builder
@Table("adapter_effectiveness_metric")
public class AdapterEffectivenessMetric {
    @Id
    private UUID metricId;

    private FundingSearchCategory category;
    private SearchEngineType adapter;
    private int totalSearches;
    private int zeroResultCount;
    private int highConfidenceCandidates;
    private BigDecimal averageConfidence;
    private LocalDateTime lastUpdated;
}
```

**Note**: Schema exists (planned in V11) but not implemented in Feature 014

---

## Database Schema (Existing Tables)

### search_result (V17)

Already created - used by SearchAdapter implementations:

```sql
CREATE TABLE search_result (
    search_result_id        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source_url              TEXT NOT NULL,
    metadata_title          TEXT,
    metadata_description    TEXT,
    search_engine_source    TEXT CHECK (search_engine_source IN ('BRAVE', 'SEARXNG', 'SERPER', 'TAVILY')),
    discovered_at           TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    session_id              UUID REFERENCES discovery_session(session_id) ON DELETE CASCADE
);

CREATE INDEX idx_search_result_session ON search_result(session_id);
CREATE INDEX idx_search_result_engine ON search_result(search_engine_source);
```

### search_session_statistics (V11)

Already created - used for zero-result tracking:

```sql
CREATE TABLE search_session_statistics (
    statistic_id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id              UUID REFERENCES discovery_session(session_id) ON DELETE CASCADE,
    search_engine           TEXT NOT NULL CHECK (search_engine IN ('BRAVE', 'SEARXNG', 'SERPER', 'TAVILY')),
    query_text              TEXT NOT NULL,
    results_count           INTEGER NOT NULL DEFAULT 0,
    zero_result             BOOLEAN NOT NULL DEFAULT false,
    average_confidence      DECIMAL(3,2),
    execution_time_ms       INTEGER,
    error_occurred          BOOLEAN NOT NULL DEFAULT false,
    error_message           TEXT,
    created_at              TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_search_session_stats_session ON search_session_statistics(session_id);
CREATE INDEX idx_search_session_stats_engine ON search_session_statistics(search_engine);
CREATE INDEX idx_search_session_stats_zero ON search_session_statistics(zero_result) WHERE zero_result = true;
```

---

## Configuration Models

### SearchAdapterProperties (New)

**Purpose**: Externalized configuration for search adapters

**Definition**:
```java
package com.northstar.funding.searchadapters.config;

@ConfigurationProperties(prefix = "search-adapters")
@Data
public class SearchAdapterProperties {

    private BraveConfig brave;
    private SerperConfig serper;
    private SearxngConfig searxng;
    private TavilyConfig tavily;

    @Data
    public static class BraveConfig {
        private String apiKey;
        private String apiUrl = "https://api.search.brave.com/res/v1/web/search";
        private int timeoutSeconds = 10;
    }

    @Data
    public static class SerperConfig {
        private String apiKey;
        private String apiUrl = "https://google.serper.dev/search";
        private int timeoutSeconds = 10;
    }

    @Data
    public static class SearxngConfig {
        private String apiUrl = "http://192.168.1.10:8080";
        private int timeoutSeconds = 10;
    }

    @Data
    public static class TavilyConfig {
        private String apiKey;
        private String apiUrl = "https://api.tavily.com/search";
        private int timeoutSeconds = 15;  // AI search may be slower
    }
}
```

**application.yml**:
```yaml
search-adapters:
  brave:
    api-key: ${BRAVE_API_KEY}
    timeout-seconds: 10
  serper:
    api-key: ${SERPER_API_KEY}
    timeout-seconds: 10
  searxng:
    api-url: http://192.168.1.10:8080
    timeout-seconds: 10
  tavily:
    api-key: ${TAVILY_API_KEY}
    timeout-seconds: 15
```

---

## Data Flow Summary

```
1. SearchWorkflowService.executeNightlySearch(MONDAY)
   ↓
2. DayOfWeekCategories.getCategories(MONDAY) → [4 categories]
   ↓
3. QueryGenerationService.generateQueries(category) → [3 queries per category = 12 queries]
   ↓
4. For each query:
     Execute in parallel (Virtual Threads):
       - BraveSearchAdapter.search(query, 10) → List<SearchResult>
       - SerperAdapter.search(query, 10) → List<SearchResult>
       - SearXNGAdapter.search(query, 10) → List<SearchResult>
       - TavilyAdapter.search(query, 10) → List<SearchResult>
   ↓
5. SearchResultProcessor.processResults(allResults)
   - Extract domains
   - Deduplicate by domain
   - Check blacklist
   - Calculate confidence scores (BigDecimal)
   - Filter by threshold (>= 0.60)
   - Create FundingSourceCandidate records (PENDING_CRAWL status)
   ↓
6. Return SearchWorkflowResult with statistics
```

---

## Next Steps

With data models defined, next create:
1. Contract YAML files defining adapter interfaces
2. Quickstart guide for manual execution
3. Update CLAUDE.md with Feature 014 context
4. Generate tasks.md from /tasks command
