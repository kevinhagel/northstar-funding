
# NorthStar Funding Discovery - Docker Compose Infrastructure
# Constitutional Compliance: PostgreSQL + pgAdmin + Qdrant + SearXNG + Kafka + Valkey
# Deployment Target: Mac Studio (192.168.1.10)
# Ollama runs natively on Mac Studio (not in Docker)

services:
  # =========================================
  # MESSAGE BROKER
  # =========================================

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: northstar-kafka
    hostname: kafka
    ports:
      - "9092:9092"
      - "9094:9094"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://192.168.1.10:9092
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:29093
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,CONTROLLER://0.0.0.0:29093,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_DELETE_TOPIC_ENABLE: 'true'
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 300000
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - northstar-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================
  # CACHE & SESSION STORE
  # =========================================

  valkey:
    image: valkey/valkey:7.2
    container_name: northstar-valkey
    hostname: valkey
    ports:
      - "6379:6379"
    command: >
      valkey-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - valkey-data:/data
    networks:
      - northstar-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================
  # DATABASE SERVICES
  # =========================================

  # PostgreSQL 16 - Primary Database (Constitutional Requirement)
  postgres:
    image: postgres:16
    container_name: northstar-postgres
    hostname: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: northstar_funding
      POSTGRES_USER: northstar_user
      POSTGRES_PASSWORD: northstar_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
      TZ: UTC
    volumes:
      # T9-NorthStar SSD for PostgreSQL data (4TB Samsung T9)
      - /Volumes/T9-NorthStar/postgresql/data:/var/lib/postgresql/data
      - ./config/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - northstar-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U northstar_user -d northstar_funding"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB

  # =========================================
  # VECTOR DATABASE
  # =========================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: northstar-qdrant
    hostname: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    expose:
      - 6333
      - 6334
      - 6335
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__LOG_LEVEL: INFO
      QDRANT__TELEMETRY_DISABLED: true
      QDRANT__CLUSTER__ENABLED: false
    volumes:
      - qdrant-data:/qdrant/storage
      - ./qdrant-config.yaml:/qdrant/config/local.yaml:ro
    networks:
      - northstar-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 45s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================
  # SEARCH ENGINE
  # =========================================

  searxng:
    container_name: northstar-searxng
    image: docker.io/searxng/searxng:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - ./searxng:/etc/searxng:rw
    environment:
      - SEARXNG_BASE_URL=http://192.168.1.10:8080/
      - SEARXNG_ENABLE_SEARCH_API=true
      - SEARXNG_USERAGENT_WHITELIST=.*
      - SEARXNG_DEFAULT_LANG=en
      - SEARXNG_ENGINES_CATEGORIES=general,news,science
    depends_on:
      valkey:
        condition: service_healthy
    networks:
      - northstar-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  # =========================================
  # AI SEARCH (PERPLEXICA)
  # =========================================
  # Version: v1.11.2 (latest as of 2025-11-07)
  # LM Studio integration (proven reliable, Ollama had parallelism issues)
  perplexica:
    image: itzcrazykns1337/perplexica:latest
    container_name: northstar-perplexica
    hostname: perplexica
    ports:
      - "3001:3000"
    volumes:
      - perplexica-data:/home/perplexica/data
      - perplexica-uploads:/home/perplexica/uploads
      - ./perplexica/config.toml:/home/perplexica/config.toml:ro
    environment:
      - SEARXNG_API_URL=http://searxng:8080
      # LM Studio (OpenAI-compatible API on port 1234)
      - LM_STUDIO_BASE_URL=http://192.168.1.10:1234
      # Network exposure for MacBook M2 access
      - NEXT_PUBLIC_API_URL=http://192.168.1.10:3001/api
      - NEXT_PUBLIC_WS_URL=ws://192.168.1.10:3001
    networks:
      - northstar-network
    restart: unless-stopped
    depends_on:
      searxng:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://perplexica:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================
  # LLM CHAT INTERFACE
  # =========================================

  # Open WebUI - Modern LLM Chat Interface
  # Replacement for Perplexica's chat functionality
  # Respects model configuration, fast responses (4-6s), no auto-discovery issues
  # Access: http://192.168.1.10:3002
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: northstar-open-webui
    hostname: open-webui
    ports:
      - "3002:8080"
    environment:
      - OLLAMA_BASE_URL=http://192.168.1.10:11434
      - WEBUI_SECRET_KEY=northstar-secret-key-change-in-production
      - ENABLE_SIGNUP=true
      - DEFAULT_USER_ROLE=user
      - WEBUI_NAME=NorthStar LLM Chat
      - DEFAULT_MODELS=llama3.1:8b
    volumes:
      - open-webui-data:/app/backend/data
    networks:
      - northstar-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================
  # MANAGEMENT TOOLS
  # =========================================

  # pgAdmin - PostgreSQL Administration Interface
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: northstar-pgadmin
    hostname: pgadmin
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: kevin@northstar.bg
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - northstar-network
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/misc/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Redis Commander - Valkey Administration Interface
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: northstar-redis-commander
    hostname: redis-commander
    ports:
      - "8082:8081"
    environment:
      - REDIS_HOSTS=valkey:valkey:6379:0
      - HTTP_USER=admin
      - HTTP_PASSWORD=admin123
    depends_on:
      valkey:
        condition: service_healthy
    networks:
      - northstar-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8081 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Kafka UI - Kafka Administration Interface
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: northstar-kafka-ui
    hostname: kafka-ui
    ports:
      - "8081:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: northstar-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      SERVER_SERVLET_CONTEXT_PATH: /kafka-ui
      LOGGING_LEVEL_COM_PROVECTUS: DEBUG
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - northstar-network
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

# =========================================
# NETWORKS
# =========================================

networks:
  northstar-network:
    name: northstar-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# =========================================
# VOLUMES (Persistent Data)
# =========================================

volumes:
  kafka-data:
    name: northstar-kafka-data
    driver: local

  valkey-data:
    name: northstar-valkey-data
    driver: local

  # postgres-data: Now using bind mount to /Volumes/T9-NorthStar/postgresql/data

  pgadmin-data:
    name: northstar-pgadmin-data
    driver: local

  qdrant-data:
    name: northstar-qdrant-data
    driver: local

  perplexica-data:
    name: northstar-perplexica-data
    driver: local

  perplexica-uploads:
    name: northstar-perplexica-uploads
    driver: local

  open-webui-data:
    name: northstar-open-webui-data
    driver: local

# =========================================
# INFRASTRUCTURE SUMMARY
# =========================================

# ✅ Core Services:
#    - Kafka (Message Broker) - Port 9092
#    - Valkey (Cache) - Port 6379
#    - PostgreSQL 16 (Database) - Port 5432
#    - Qdrant (Vector DB) - Ports 6333, 6334
#    - SearXNG (Search) - Port 8080
#    - Perplexica (AI Search) - Port 3001
#    - Open WebUI (LLM Chat) - Port 3002
#
# ✅ Management Tools:
#    - pgAdmin (PostgreSQL UI) - Port 5050
#    - Redis Commander (Valkey UI) - Port 8082
#    - Kafka UI (Kafka UI) - Port 8081
#
# ✅ External Dependencies:
#    - Ollama runs NATIVELY on Mac Studio (192.168.1.10:11434)
#    - All services use single 'northstar-network' bridge network
#    - Persistent volumes for all stateful services
#
