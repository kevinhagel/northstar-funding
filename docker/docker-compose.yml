
# NorthStar Funding Discovery - Docker Compose Infrastructure
# Constitutional Compliance: PostgreSQL + pgAdmin + Qdrant + SearXNG
# Deployment Target: Mac Studio (192.168.1.10)
# LM Studio runs natively on Mac Studio (not in Docker)

services:
  # =========================================
  # DATABASE SERVICES
  # =========================================
  
  # PostgreSQL 16 - Primary Database (Constitutional Requirement)
  postgres:
    image: postgres:16
    container_name: northstar-postgres
    hostname: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: northstar_funding
      POSTGRES_USER: northstar_user
      POSTGRES_PASSWORD: northstar_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
      TZ: UTC
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./config/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - northstar-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U northstar_user -d northstar_funding"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # pgAdmin - PostgreSQL Administration Interface
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: northstar-pgadmin
    hostname: pgadmin
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: kevin@northstar.bg
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - northstar-network
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/misc/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # VECTOR DATABASE
  # =========================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    hostname: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    expose:
      - 6333
      - 6334
      - 6335
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__LOG_LEVEL: INFO
      QDRANT__TELEMETRY_DISABLED: true
      QDRANT__CLUSTER__ENABLED: false
    volumes:
      - qdrant-data:/qdrant/storage
      - ./qdrant-config.yaml:/qdrant/config/local.yaml:ro
    networks:
      - northstar-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 45s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # SearXNG - Open Source Search Engine for Funding Discovery
  # =========================================
  # SEARCH ENGINE
  # =========================================

  searxng:
    container_name: searxng
    image: docker.io/searxng/searxng:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - ./searxng:/etc/searxng:rw
    environment:
      - SEARXNG_BASE_URL=http://192.168.1.10:8080/
      - SEARXNG_ENABLE_SEARCH_API=true
      - SEARXNG_USERAGENT_WHITELIST=.*
      - SEARXNG_DEFAULT_LANG=en
      - SEARXNG_ENGINES_CATEGORIES=general,news,science
    networks:
      - northstar-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

# =========================================
# NETWORKS
# =========================================

networks:
  northstar-network:
    name: northstar-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# =========================================
# VOLUMES (Persistent Data)
# =========================================

volumes:
  postgres-data:
    name: northstar-postgres-data
    driver: local
  
  pgadmin-data:
    name: northstar-pgadmin-data
    driver: local
  
  qdrant-data:
    name: northstar-qdrant-data
    driver: local

# =========================================
# CONSTITUTIONAL COMPLIANCE VERIFICATION
# =========================================

# ✅ Technology Stack (NON-NEGOTIABLE):
#    - PostgreSQL 16 for structured data storage
#    - pgAdmin for database administration
#    - Qdrant for RAG/vector storage (when needed)
#    - SearXNG for funding opportunity discovery
#    - LM Studio runs NATIVELY on Mac Studio (not containerized)
#
# ✅ Complexity Management (ESSENTIAL):
#    - 4 infrastructure services only
#    - Single network, clear service boundaries
#    - Application services (Backend/Frontend) deployed separately
#
# ✅ Infrastructure Integration:
#    - Mac Studio deployment target (192.168.1.10)
#    - Persistent data volumes for reliability
#    - Health monitoring for all services
#    - Configuration files properly mounted
